{% extends "chatbox_app/base.html" %}

{% block title %}Session {{ session.pk }} - Chatbox IA{% endblock %}

{% block content %}
<section class="chat-header glass-card mb-4">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
        <div>
            <span class="badge rounded-pill bg-primary-subtle text-primary mb-2">Session #{{ session.pk }}</span>
            <h1 class="h3 text-white mb-2">{{ session.name|default:"Session collaborative" }}</h1>
            <p class="text-white-50 mb-0">Ouverte le {{ session.created_at|date:"d F Y à H\hi" }} — Partagez vos idées, fichiers et prompts IA.</p>
        </div>
        <div class="quick-stats d-flex gap-3">
            <div class="stat-pill">
                <span class="stat-value">{{ chat_messages|length }}</span>
                <span class="stat-label">Messages</span>
            </div>
            <div class="stat-pill">
                <span class="stat-value">{{ videos|length }}</span>
                <span class="stat-label">Vidéos IA</span>
            </div>
        </div>
    </div>
</section>

<div class="row g-4">
    <aside class="col-lg-3">
        <div class="glass-card">
            <div class="card-body">
                <h2 class="h6 text-white mb-3">Sessions</h2>
                <nav class="session-nav">
                    {% for s in sessions %}
                        <a href="{% url 'chatbox_app:chat_session' s.pk %}" class="session-link {% if s.pk == session.pk %}active{% endif %}">
                            <div class="session-link-title">{{ s.name|default:"Session sans titre" }}</div>
                            <small class="text-white-50">{{ s.created_at|date:"d/m à H\hi" }}</small>
                        </a>
                    {% empty %}
                        <div class="empty-state text-center py-4">
                            <i class="fa-regular fa-face-smile-beam fa-2x text-white-25 mb-2"></i>
                            <p class="text-white-50 mb-0">Aucune autre session.</p>
                        </div>
                    {% endfor %}
                </nav>
            </div>
        </div>
    </aside>

    <section class="col-lg-9">
        <div class="glass-card mb-4">
            <div class="card-body p-0">
                <div class="chat-scroller">
                    {% for message in chat_messages %}
                        <div class="chat-bubble chat-bubble-{{ message.sender }}">
                            <div class="bubble-header">
                                <span class="bubble-sender"><i class="fa-regular fa-user me-2"></i>{{ message.get_sender_display }}</span>
                                <span class="bubble-time"><i class="fa-regular fa-clock me-1"></i>{{ message.created_at|date:"d/m/Y H:i" }}</span>
                            </div>
                            {% if message.content %}
                                <div class="bubble-content">{{ message.content|linebreaks }}</div>
                            {% endif %}
                            {% if message.attachment %}
                                <div class="bubble-attachment">
                                    {% if "image" in message.attachment_type %}
                                        <img src="{{ message.attachment.url }}" class="attachment-image" alt="Pièce jointe">
                                    {% elif "video" in message.attachment_type %}
                                        <div class="ratio ratio-16x9">
                                            <video controls>
                                                <source src="{{ message.attachment.url }}" type="{{ message.attachment_type }}">
                                            </video>
                                        </div>
                                    {% else %}
                                        <a href="{{ message.attachment.url }}" class="btn btn-outline-light btn-sm" download>
                                            <i class="fa-solid fa-download me-2"></i>Télécharger la pièce jointe
                                        </a>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    {% empty %}
                        <div class="empty-state text-center py-5">
                            <i class="fa-regular fa-message fa-3x mb-3 text-white-25"></i>
                            <p class="text-white-50 mb-0">Aucun message pour le moment. Soyez le premier à écrire !</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-xl-7">
                <div class="glass-card">
                    <div class="card-body">
                        <h2 class="h5 text-white mb-3"><i class="fa-regular fa-paper-plane me-2"></i>Envoyer un message</h2>
                        <form method="post" enctype="multipart/form-data" class="form-stacked">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="send_message">
                            {{ message_form.non_field_errors }}
                            <div class="mb-3">
                                {{ message_form.content.label_tag }}
                                {{ message_form.content }}
                            </div>
                            <div class="mb-3">
                                {{ message_form.attachment.label_tag }}
                                <div class="modern-file">
                                    <i class="fa-regular fa-file-arrow-up"></i>
                                    {{ message_form.attachment }}
                                </div>
                                <small class="form-text text-white-50">Formats supportés : images, vidéos, PDF, ZIP...</small>
                            </div>
                            <div class="text-end">
                                <button type="submit" class="btn btn-gradient">Envoyer</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-xl-5">
                <div class="glass-card accent-card h-100">
                    <div class="card-body">
                        <h2 class="h5 text-white mb-3"><i class="fa-solid fa-wand-magic-sparkles me-2"></i>Génération vidéo IA</h2>
                        <p class="text-white-50">Décrivez la scène souhaitée et laissez l'IA produire un rendu vidéo personnalisé.</p>
                        <form method="post" class="form-stacked mt-3">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="generate_video">
                            {{ video_form.non_field_errors }}
                            <div class="mb-3">
                                {{ video_form.prompt.label_tag }}
                                {{ video_form.prompt }}
                            </div>
                            <button type="submit" class="btn btn-outline-light w-100">Lancer la génération</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h2 class="h5 text-white mb-1">Vidéos générées</h2>
                        <p class="text-white-50 mb-0">Suivez la progression de vos créations IA.</p>
                    </div>
                    <span class="badge bg-info text-dark"><i class="fa-regular fa-circle-play me-2"></i>Historique</span>
                </div>
                <div class="timeline">
                    {% for video in videos %}
                        <div class="timeline-item">
                            <div class="timeline-icon status-{{ video.status }}">
                                <i class="fa-solid fa-circle"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h3 class="h6 text-white mb-0">{{ video.prompt|truncatechars:80 }}</h3>
                                    <span class="badge status-badge status-{{ video.status }}">{{ video.get_status_display }}</span>
                                </div>
                                <small class="text-white-50">Créée le {{ video.created_at|date:"d/m/Y H:i" }}</small>
                                {% if video.video_url %}
                                    <div class="mt-2">
                                        <a href="{{ video.video_url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                            <i class="fa-solid fa-play me-1"></i>Regarder la vidéo
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% empty %}
                        <div class="empty-state text-center py-5">
                            <i class="fa-solid fa-video-slash fa-3x mb-3 text-white-25"></i>
                            <p class="text-white-50 mb-0">Aucune vidéo générée pour le moment. Lancez une description pour commencer.</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
function pollVideoStatus(videoId) {
    fetch(`/videos/${videoId}/status/`)
        .then(response => response.json())
        .then(data => {
            if (data.status === "completed" && data.video_url) {
                window.location.reload();
            } else if (data.status === "failed") {
                console.error("Échec de la génération vidéo");
            } else {
                setTimeout(() => pollVideoStatus(videoId), 5000);
            }
        })
        .catch(error => console.error("Erreur de polling", error));
}
</script>
{% endblock %}
